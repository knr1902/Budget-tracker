<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Expense & Settlement Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; background-color: #f3f4f6; }
        .app-container { overscroll-behavior: none; }
        main { scrollbar-width: none; }
        main::-webkit-scrollbar { display: none; }
        .nav-btn.active { background-color: #eef2ff; }
        .nav-btn.active svg { color: #4f46e5; }
        .nav-btn.active span { color: #111827; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .syncing { animation: pulse 1s infinite; }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }
        .autocomplete-items div:hover { background-color: #e9e9e9; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center md:p-4">

    <div class="app-container w-full h-full md:max-w-7xl md:h-[90vh] md:max-h-[900px] bg-white md:rounded-2xl md:shadow-xl flex flex-col md:flex-row overflow-hidden">
        
        <nav class="order-last md:order-first flex-shrink-0 bg-white/80 backdrop-blur-sm flex justify-around p-2 border-t border-gray-200 md:flex-col md:w-24 md:justify-start md:space-y-4 md:p-3 md:border-t-0 md:border-r">
            <button class="nav-btn flex-1 md:flex-initial flex flex-col items-center justify-center text-gray-500 p-2 rounded-lg transition-colors duration-200 active" data-view="home-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                <span class="text-xs font-medium mt-1">Home</span>
            </button>
            <button class="nav-btn flex-1 md:flex-initial flex flex-col items-center justify-center text-gray-500 p-2 rounded-lg transition-colors duration-200" data-view="reports-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span class="text-xs font-medium mt-1">Reports</span>
            </button>
            <button class="nav-btn flex-1 md:flex-initial flex flex-col items-center justify-center text-gray-500 p-2 rounded-lg transition-colors duration-200" data-view="settle-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                <span class="text-xs font-medium mt-1">Settlements</span>
            </button>
        </nav>

        <div class="flex-1 flex flex-col overflow-y-hidden relative">
            <header class="flex-shrink-0 bg-white/80 backdrop-blur-sm p-4 flex justify-between items-center border-b border-gray-200">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">KNR Budget Tracker</h1>
                    <p id="sync-status" class="text-[10px] text-gray-400 font-medium flex items-center gap-1">
                        <span id="sync-icon" class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                        <span id="sync-text">Checking...</span>
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-400">Total Spent</p>
                    <p id="total-spent-val" class="text-lg font-bold text-indigo-600">₹0</p>
                </div>
            </header>

            <main class="flex-1 p-4 lg:p-6 bg-gray-50 overflow-y-auto">
                <div id="home-view" class="space-y-6">
                    <section class="bg-indigo-600 rounded-2xl p-5 text-white shadow-lg">
                        <h2 class="text-sm font-medium opacity-90 mb-1">Daily Spending Guide</h2>
                        <div class="flex items-end justify-between">
                            <div>
                                <p id="daily-allowance" class="text-4xl font-bold">₹0</p>
                                <p id="days-left" class="text-xs opacity-75 mt-1">Calculating...</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs opacity-75">Remaining Budget</p>
                                <p id="total-remaining" class="text-lg font-semibold">₹0</p>
                            </div>
                        </div>
                    </section>

                    <section class="bg-white rounded-2xl p-4 border border-gray-200">
                        <div class="flex gap-2">
                            <select id="home-month" class="flex-1 p-2 bg-gray-50 rounded-lg text-sm border outline-none"></select>
                            <select id="home-year" class="flex-1 p-2 bg-gray-50 rounded-lg text-sm border outline-none"></select>
                        </div>
                    </section>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <section class="bg-white rounded-2xl p-4 border border-gray-200">
                            <h2 class="text-md font-bold mb-4">Breakdown</h2>
                            <div class="h-48 flex items-center justify-center">
                                <canvas id="pie-chart"></canvas>
                            </div>
                        </section>
                        <section class="bg-white rounded-2xl p-4 border border-gray-200">
                            <h2 class="text-md font-bold mb-4">Budgets</h2>
                            <div class="overflow-y-auto max-h-48">
                                <table class="w-full text-sm"><tbody id="budget-body" class="divide-y"></tbody></table>
                            </div>
                        </section>
                    </div>

                    <section class="bg-white rounded-2xl p-4 border border-gray-200">
                        <h2 class="text-md font-bold mb-4">Recent Transactions</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-gray-400 border-b"><tr><th class="py-2">Date</th><th>Cat</th><th class="text-right">Amt</th></tr></thead>
                                <tbody id="history-body" class="divide-y"></tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <div id="reports-view" class="hidden space-y-6">
                    <section class="bg-white rounded-2xl p-4 border border-gray-200">
                        <h2 class="text-lg font-bold mb-4">FY Trend (Apr - Mar)</h2>
                        <div class="flex gap-2 mb-4">
                            <select id="trend-year" class="flex-1 p-2 bg-gray-50 rounded-lg text-sm border"></select>
                            <select id="trend-cat" class="flex-1 p-2 bg-gray-50 rounded-lg text-sm border"></select>
                        </div>
                        <div class="h-64 flex items-center justify-center">
                            <canvas id="bar-chart"></canvas>
                        </div>
                    </section>
                </div>

                <div id="settle-view" class="hidden space-y-6">
                    <section class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100">
                        <h2 class="text-sm font-bold text-indigo-700 mb-4">New Settlement Entry</h2>
                        <form id="settle-form" class="grid grid-cols-2 gap-3 text-xs autocomplete relative">
                            <input type="date" id="s-date" class="p-3 rounded-xl border col-span-1" required>
                            <select id="s-tab" class="p-3 rounded-xl border col-span-1">
                                <option value="Family">Family Tab</option>
                                <option value="Others">Others Tab</option>
                            </select>
                            <div class="col-span-2 relative">
                                <input type="text" id="s-name" placeholder="Person Name" class="p-3 rounded-xl border w-full" required autocomplete="off">
                                <div id="s-name-list" class="autocomplete-items"></div>
                            </div>
                            <select id="s-type" class="p-3 rounded-xl border col-span-1">
                                <option value="Borrowed">Borrowed (I owe)</option>
                                <option value="Lent">Lent (They owe)</option>
                            </select>
                            <input type="number" id="s-amt" placeholder="Amount" class="p-3 rounded-xl border col-span-1" required>
                            <button type="submit" id="s-btn" class="col-span-2 bg-indigo-600 text-white font-bold py-3 rounded-xl transition-all active:scale-95">Save to Sheet</button>
                        </form>
                    </section>

                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 px-1">Family Members</h3>
                        <div id="family-grid" class="grid grid-cols-2 gap-3"></div>
                    </div>

                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 px-1">Others</h3>
                        <div id="others-grid" class="grid grid-cols-2 gap-3"></div>
                    </div>
                </div>

                <div id="add-expense-view" class="hidden">
                    <div class="max-w-md mx-auto bg-white rounded-2xl p-6 border border-gray-200">
                        <h2 class="text-lg font-bold mb-4">New Expense</h2>
                        <form id="expense-form" class="space-y-4">
                            <input type="date" id="e-date" class="w-full p-3 border rounded-xl" required>
                            <select id="e-cat" class="w-full p-3 border rounded-xl" required></select>
                            <input type="number" id="e-amt" placeholder="Amount" class="w-full p-3 border rounded-xl" required>
                            <button type="submit" id="exp-save-btn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold transition-all active:scale-95">Save</button>
                        </form>
                    </div>
                </div>
            </main>
            
            <button id="fab" class="absolute bottom-20 right-5 md:bottom-6 md:right-6 bg-indigo-600 text-white rounded-full p-4 shadow-lg active:scale-90 z-10">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
            </button>
        </div>
    </div>

    <script>
        const URL = 'https://script.google.com/macros/s/AKfycbxB_KnSJeWS22oowIrr-bGoVQdhxjI4Io1BuMnvbFnuJUK2p-AXMTiYjkAUookZCbDP/exec';
        let charts = { pie: null, bar: null };
        let cachedData = null;
        let existingNames = [];
        // Color Palette for categories
        const categoryColors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#EC4899', '#3B82F6', '#8B5CF6', '#06B6D4'];

        document.addEventListener('DOMContentLoaded', () => {
            initFilters();
            load();
            setupNav();
            setupAutocomplete();
        });

        function updateSyncStatus(status) {
            const icon = document.getElementById('sync-icon');
            const text = document.getElementById('sync-text');
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            if (status === 'syncing') {
                icon.className = 'w-1.5 h-1.5 bg-yellow-500 rounded-full syncing';
                text.innerText = 'Syncing...';
            } else if (status === 'success') {
                icon.className = 'w-1.5 h-1.5 bg-green-500 rounded-full';
                text.innerText = `Synced at ${now}`;
            } else {
                icon.className = 'w-1.5 h-1.5 bg-red-500 rounded-full';
                text.innerText = 'Sync error';
            }
        }

        function initFilters() {
            const mSel = document.getElementById('home-month');
            const ySel = document.getElementById('home-year');
            const tySel = document.getElementById('trend-year');
            const now = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            mSel.innerHTML = monthNames.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            mSel.value = now.getMonth();
            const curY = now.getFullYear();
            for(let i = curY - 2; i <= 2035; i++) {
                ySel.innerHTML += `<option value="${i}">${i}</option>`;
                tySel.innerHTML += `<option value="${i}">${i}-${i+1} (FY)</option>`;
            }
            ySel.value = curY;
            tySel.value = curY;
            mSel.onchange = () => renderUI(cachedData);
            ySel.onchange = () => renderUI(cachedData);
            tySel.onchange = () => renderTrendChart(cachedData);
            document.getElementById('trend-cat').onchange = () => renderTrendChart(cachedData);
        }

        function setupNav() {
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach(b => b.onclick = () => {
                const v = b.dataset.view;
                ['home-view', 'reports-view', 'settle-view', 'add-expense-view'].forEach(id => document.getElementById(id).classList.toggle('hidden', id !== v));
                btns.forEach(btn => btn.classList.toggle('active', btn === b));
                if(v === 'reports-view') renderTrendChart(cachedData);
                if(v === 'settle-view') {
                    renderSettlements(cachedData.family, 'family-grid');
                    renderSettlements(cachedData.others, 'others-grid');
                }
            });
            document.getElementById('fab').onclick = () => {
                ['home-view', 'settle-view', 'reports-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById('add-expense-view').classList.remove('hidden');
                document.getElementById('e-date').valueAsDate = new Date();
            };
        }

        async function load() {
            updateSyncStatus('syncing');
            try {
                const res = await fetch(URL);
                cachedData = await res.json();
                const familyNames = cachedData.family.slice(1).map(r => r[2]);
                const otherNames = cachedData.others.slice(1).map(r => r[2]);
                existingNames = [...new Set([...familyNames, ...otherNames])].filter(n => n);
                renderUI(cachedData);
                updateSyncStatus('success');
            } catch (e) {
                updateSyncStatus('error');
            }
        }

        function setupAutocomplete() {
            const input = document.getElementById("s-name");
            const list = document.getElementById("s-name-list");
            input.oninput = function() {
                const val = this.value;
                list.innerHTML = "";
                if (!val) return;
                const matches = existingNames.filter(n => n.toLowerCase().includes(val.toLowerCase()));
                matches.forEach(name => {
                    const div = document.createElement("div");
                    div.innerHTML = `<strong>${name.substr(0, val.length)}</strong>${name.substr(val.length)}`;
                    div.onclick = function() {
                        input.value = name;
                        list.innerHTML = "";
                    };
                    list.appendChild(div);
                });
            };
            document.addEventListener("click", (e) => { if (e.target !== input) list.innerHTML = ""; });
        }

        function renderUI(data) {
            if(!data) return;
            const entries = data.entries.slice(1);
            const budgets = data.budgets.slice(1);
            const selM = parseInt(document.getElementById('home-month').value);
            const selY = parseInt(document.getElementById('home-year').value);
            const filtered = entries.filter(e => {
                const d = new Date(e[1]);
                return d.getMonth() === selM && d.getFullYear() === selY;
            });
            const eCat = document.getElementById('e-cat');
            const tCat = document.getElementById('trend-cat');
            if(eCat.options.length <= 0) {
                eCat.innerHTML = '<option value="">Select Category</option>';
                tCat.innerHTML = '<option value="all">All Categories</option>';
                budgets.forEach(b => {
                    const opt = `<option value="${b[0]}">${b[0]}</option>`;
                    eCat.innerHTML += opt;
                    tCat.innerHTML += opt;
                });
            }
            const bMap = {}; 
            filtered.forEach(e => bMap[e[2]] = (bMap[e[2]] || 0) + parseFloat(e[3]));
            const totalBudget = budgets.reduce((sum, b) => sum + parseFloat(b[1]), 0);
            const totalSpent = Object.values(bMap).reduce((a, b) => a + b, 0);
            const totalRem = totalBudget - totalSpent;
            const now = new Date();
            let daysLeft = 1;
            if (selM === now.getMonth() && selY === now.getFullYear()) {
                const lastDay = new Date(selY, selM + 1, 0).getDate();
                daysLeft = (lastDay - now.getDate()) + 1;
                document.getElementById('days-left').innerText = `${daysLeft} days left in current month`;
            } else {
                daysLeft = new Date(selY, selM + 1, 0).getDate();
                document.getElementById('days-left').innerText = `${daysLeft} days in period`;
            }
            document.getElementById('daily-allowance').innerText = `₹${totalRem > 0 ? (totalRem / daysLeft).toFixed(0) : 0}`;
            document.getElementById('total-remaining').innerText = `₹${totalRem.toFixed(0)}`;
            document.getElementById('total-spent-val').innerText = `₹${totalSpent.toFixed(0)}`;
            const bBody = document.getElementById('budget-body');
            bBody.innerHTML = budgets.map(b => {
                const spent = bMap[b[0]] || 0;
                const rem = b[1] - spent;
                return `<tr><td class="py-2 font-medium">${b[0]}</td><td><input type="number" value="${b[1]}" class="w-16 border-b text-center outline-none bg-transparent" onchange="updB('${b[0]}',this.value)"></td><td class="${rem<0?'text-red-500 font-bold':'text-green-500'}">₹${rem.toFixed(0)}</td></tr>`;
            }).join('');
            const hBody = document.getElementById('history-body');
            hBody.innerHTML = [...filtered].reverse().slice(0, 15).map(e => `<tr><td class="py-3 text-xs text-gray-400">${new Date(e[1]).toLocaleDateString()}</td><td class="font-medium">${e[2]}</td><td class="text-right font-bold">₹${e[3]}</td></tr>`).join('');
            const pCtx = document.getElementById('pie-chart').getContext('2d');
            if(charts.pie) charts.pie.destroy();
            charts.pie = new Chart(pCtx, { type: 'doughnut', data: { labels: Object.keys(bMap), datasets: [{ data: Object.values(bMap), backgroundColor: categoryColors }] }, options: { plugins: { legend: { display: false } }, cutout: '70%', responsive: true, maintainAspectRatio: false } });
        }

        function renderSettlements(rows, gridId) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';
            const balances = {};
            rows.slice(1).forEach(r => {
                const name = r[2], type = r[3], amt = parseFloat(r[4]);
                if(!name) return;
                if(!balances[name]) balances[name] = 0;
                balances[name] += (type === 'Lent' ? amt : -amt);
            });
            for(let name in balances) {
                const bal = balances[name];
                grid.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-400 font-bold mb-1 uppercase">${name}</p>
                        <p class="text-sm font-bold ${bal >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${bal >= 0 ? 'Owning: ₹' : 'Owe: ₹'}${Math.abs(bal)}
                        </p>
                    </div>`;
            }
        }

        function renderTrendChart(data) {
            if(!data) return;
            const entries = data.entries.slice(1);
            const budgets = data.budgets.slice(1);
            const fyStart = parseInt(document.getElementById('trend-year').value);
            const filterCat = document.getElementById('trend-cat').value;
            const months = ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar"];
            
            // Map categories to colors
            const catColorMap = {};
            budgets.forEach((b, i) => catColorMap[b[0]] = categoryColors[i % categoryColors.length]);

            let chartDataSets = [];

            if (filterCat === 'all') {
                // Stacked bar chart showing all categories per month
                const monthlyCatData = {};
                budgets.forEach(b => {
                    monthlyCatData[b[0]] = new Array(12).fill(0);
                });

                entries.forEach(e => {
                    const d = new Date(e[1]);
                    const m = d.getMonth();
                    const y = d.getFullYear();
                    const fyIdx = (m >= 3) ? m - 3 : m + 9;
                    const fyYear = (m >= 3) ? y : y - 1;
                    if(fyYear === fyStart && monthlyCatData[e[2]]) {
                        monthlyCatData[e[2]][fyIdx] += parseFloat(e[3]);
                    }
                });

                chartDataSets = Object.keys(monthlyCatData).map(cat => ({
                    label: cat,
                    data: monthlyCatData[cat],
                    backgroundColor: catColorMap[cat],
                    borderRadius: 5
                }));
            } else {
                // Single category view with its specific color
                const values = new Array(12).fill(0);
                entries.forEach(e => {
                    const d = new Date(e[1]);
                    const m = d.getMonth();
                    const y = d.getFullYear();
                    const fyIdx = (m >= 3) ? m - 3 : m + 9;
                    const fyYear = (m >= 3) ? y : y - 1;
                    if(fyYear === fyStart && e[2] === filterCat) values[fyIdx] += parseFloat(e[3]);
                });

                chartDataSets = [{
                    label: filterCat,
                    data: values,
                    backgroundColor: catColorMap[filterCat] || '#4F46E5',
                    borderRadius: 5
                }];
            }

            const bCtx = document.getElementById('bar-chart').getContext('2d');
            if(charts.bar) charts.bar.destroy();
            charts.bar = new Chart(bCtx, { 
                type: 'bar', 
                data: { labels: months, datasets: chartDataSets }, 
                options: { 
                    scales: { y: { beginAtZero: true }, x: { stacked: true }, y: { stacked: true } }, 
                    plugins: { legend: { display: filterCat === 'all' } }, 
                    responsive: true, 
                    maintainAspectRatio: false 
                } 
            });
        }

        async function updB(c, a) {
            updateSyncStatus('syncing');
            await fetch(URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'update_budget', category: c, amount: a }) });
            load();
        }

        document.getElementById('expense-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('exp-save-btn');
            btn.innerText = "Syncing...";
            updateSyncStatus('syncing');
            const p = { date: document.getElementById('e-date').value, category: document.getElementById('e-cat').value, amount: document.getElementById('e-amt').value };
            await fetch(URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(p) });
            btn.innerText = "Save";
            document.getElementById('expense-form').reset();
            document.querySelector('[data-view="home-view"]').click();
            load();
        };

        document.getElementById('settle-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('s-btn');
            btn.innerText = "Syncing...";
            updateSyncStatus('syncing');
            const p = { action: 'settlement', tab: document.getElementById('s-tab').value, date: document.getElementById('s-date').value, name: document.getElementById('s-name').value, type: document.getElementById('s-type').value, amount: document.getElementById('s-amt').value };
            await fetch(URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(p) });
            btn.innerText = "Save to Sheet";
            document.getElementById('settle-form').reset();
            load();
        };
    </script>
</body>
</html>
